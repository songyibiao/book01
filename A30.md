# 程序框架

打开 `MiaowLabs两轮自平衡小车「小霸王Lite」光盘\02、程序源代码\Mwbalanced-stm32-小霸王Lite-firmware-互补滤波-none V3.33\BasicBalance.uvprojx` 工程文件，展开工程分组如下图所示：

![工程分组](/img/2019-12-22_223137.png)

如图所示，可以看到工程分有 6 个分组，其中 FWlib 分组主要是 HAL 库的文件代码，CMSIS 分组主要是 Cortex-M3 核心的文件代码，Startup 分组是 stm32f10x 的启动文件代码，BSP 分组主要是外设硬件的驱动程序代码，比如 MPU6050、oled 等，SYS 分组主要是滴答定时器和调试相关的配置代码，USER 分组是用户代码。

下面我们先讲解一下 USER 分组的 main.c。main.c 包含了所有硬件初始化和参数初始化代码。初始化代码如下：

```
int main(void)
{	
	
	BspInit();				//初始化BSP

	PIDInit(); 				//初始化PID
	
	CarUpstandInit(); 	//初始化系统参数
	
	SysTick_Init();			//初始化定时器	
	
	if(IsInfrareOK())
		g_iGravity_Offset = 1; //若果检测到悬挂红外模块，则更改偏移值。
	
	ShowHomePageInit();
 
	while (1)
	{
		
		SecTask();			//秒级任务

		if(SoftTimer[1] == 0)
		{// 每隔50ms 执行一次
			SoftTimer[1] = 20;
			ResponseIMU();			
			DebugService();			
			Parse(Uart3Buffer);
			
		}			
  	
		if(SoftTimer[2] == 0)
		{
			SoftTimer[2] = 20;
			ShowHomePage();
	
			Read_Distane();

			if(g_CarRunningMode == ULTRA_FOLLOW_MODE){
				if(IsUltraOK())UltraControl(0);	//超声波跟随模式
	 		}
			if(g_CarRunningMode == ULTRA_AVOID_MODE){
				if(IsUltraOK())UltraControl(1);	//超声波避障模式
	 		}
			else if(g_CarRunningMode == INFRARED_TRACE_MODE){
				TailingControl();
			}
		}			
	}
}
```