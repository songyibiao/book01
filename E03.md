# 运动速度控制

在《Timer编码器模式读取编码器》一节中，我们配置了 TIM4，没有配置 TIM2，在这里对 TIM2 进行补充配置，其实很简单，跟之前配置 TIM4 一样的。 

进入我们上一小节修改过的 MiaowLabs-Demo 文件夹，找到 MiaowLabs-Demo.ioc 工程文件，双击，打开工程。在左侧 Pinout&Configuration 界面中的 Timers 下拉中点击 TIM2，然后在 TIM2 Mode and Configuration 的 Mode 中将 Combined Channels 选择为 Encoder Mode，即编码器模式。

在 Configuration 中选择 Parameter Setting 选项卡，进行基本参数配置。其中，Counter Mode 默认为 Up，即向上计数。Counter Period 设置为 65535，即计数器周期，这是一个 16 位的自动加载寄存器，填写范围为 0~65535。Encoder Mode 设置为 Encoder Mode TI1 and TI2，即两个输入 TI1 和 TI2 都被用来作为增量编码器的接口。Polarity 默认为 Rising Edge，即为捕获上升沿。其他参数默认即可。

![配置 TIM2 ](/img/2019-08-04_211008.png)

两轮自平衡小车的运动速度控制采用PI控制：

u<sub>speed</sub>(t)=PID(e<sub>v</sub>)=k<sub>p</sub>*e<sub>v</sub>+k<sub>i</sub>*∫e<sub>v</sub>dt+k<sub>d</sub>(de<sub>v</sub>)/dt

其中，e<sub>v</sub>=v<sub>φ</sub>-v<sub>D</sub>是实际行进速度v<sub>φ</sub>与期望行进速度v<sub>D</sub>的差。

值得注意的是，行进速度的控制器PID(e<sub>v</sub>)是一个正反馈回路。

上式中，各项的特征与作用在于：

1、比例项k<sub>p</sub>>0，正反馈项，调节两轮自平衡小车的行进速度。

2、积分项k<sub>i</sub>≥0，正反馈项，累积位移差形成的位移势能，这种位移势能不仅能消除速度静差，还可以保障小车在复杂路面（包含坡度）行进时行进速度的平稳，另外，使小车具备突破障碍的能力。

3、微分项k<sub>d</sub>≤0，负反馈项，消除系统的自激和振荡。

在两轮自平衡小车速度环控制器中，起主导作用的是比例项，其次是积分项，因此速度环是一个正反馈回路。在实际应用中，大部分两轮自平衡小车不使用微分项，只使用比例项和积分项，即PI(e<sub>v</sub>)。

设计制作两轮自平衡小车，其中的一个难点就在速度环中：是否理解两轮自平衡小车在内含正反馈回路的情形下如何保持稳定并实现运动平衡。


